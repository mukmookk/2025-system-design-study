## 4.5 Stateful / Stateless 로드밸런싱 혼합 사례

### 목차

- [외부(엣지) LB는 Stateful, 내부 LB는 Stateless](#1-외부엣지-lb는-stateful-내부-lb는-stateless)
- [같은 LB 안에서 URL/서비스별로 Stateful + Stateless 혼용](#2-같은-lb-안에서-url서비스별로-stateful--stateless-혼용)
- [Consistent Hashing + 동적 알고리즘 혼합](#3-consistent-hashingstateless--동적-알고리즘least-connections-혼합)
- [전역은 Stateless, 지역은 Stateful or Semi-Stateful](#4-전역dnsgslb은-stateless-지역local-lb은-stateful-or-semi-stateful)
- [세션은 외부 저장 + 보조적 IP Hash 사용](#5-세션은-외부-저장완전-stateless--보조적으로-ip-hash-사용)

실제 운영 환경에서는 로드밸런서를 완전히 Stateful 또는 Stateless 한 방식으로만 쓰기보다,  
**계층별·용도별로 두 방식을 혼합**해서 사용하는 경우가 많다.

---

### 1) 외부(엣지) LB는 Stateful, 내부 LB는 Stateless

구조 예:

Client  
→ **엣지 L7 LB (세션 스티키, Stateful)**  
→ **내부 L4/L7 LB (Stateless, 라운드로빈/Least-Connections)**  
→ App Servers

- 엣지 LB:
  - 쿠키 기반 세션 스티키(예: `LBSESSIONID`)로  
    특정 사용자를 항상 같은 서비스 그룹/존으로 보내는 역할
  - 로그인 세션을 “어느 존/팟으로 보낼지”를 고정하는 용도
- 내부 LB:
  - 같은 존 안에서는 Stateless + 동적 알고리즘(Least Connections, Least Response Time)으로  
    서버 부하에 따라 자유롭게 분배

효과:
- 바깥에서는 세션 지속성(Session Affinity)을 어느 정도 유지  
- 내부에서는 서버 추가/삭제에 유연한 Stateless + 동적 분배로 확장성 확보

---

### 2) 같은 LB 안에서 URL/서비스별로 Stateful + Stateless 혼용

예시:

- `/api/auth/**` (로그인, 마이페이지 등 세션 민감):
  - **IP Hash / Cookie 기반 Sticky (사실상 Stateful 동작)**

- `/static/**`, `/images/**` (정적 리소스, 세션 필요 없음):
  - **Stateless Round Robin / Least Connections**

효과:
- 세션이 필요한 엔드포인트는 “동일 서버 유지”로 UX 안정성 확보  
- 나머지 트래픽은 Stateless로 분산해 전체 부하를 고르게 유지

---

### 3) Consistent Hashing(Stateless) + 동적 알고리즘(Least Connections) 혼합

일부 시스템은 **기본은 해시 기반이지만, 부하가 쏠리면 동적 알고리즘을 곁들이는** 형태를 사용한다.

예:

1. 1차 분배: IP Hash / Consistent Hashing으로 “항상 같은 서버”에 매핑  
2. 2차 보정: 해당 서버가 과부하면  
   - 같은 파티션 내 다른 서버로 리다이렉트  
   - 또는 Least Connections 기반 재조정

효과:
- 기본적으로는 Stateless + 세션 친화적인 분배  
- 하지만 특정 서버가 터지는 상황은 동적으로 회피

---

### 4) 전역(DNS/GSLB)은 Stateless, 지역(Local LB)은 Stateful or Semi-Stateful

구조 예:

Client  
→ **DNS 기반 GSLB (Stateless, 단순 IP 반환)**  
→ **Region Load Balancer (Sticky Session, IP Hash, Stateful 성격)**  
→ App Servers

- DNS/GSLB:
  - 지리/레이턴시 기반으로 “어느 리전에 보낼지”만 결정 (Stateless)
- Region LB:
  - 해당 리전 내에서 세션 지속성이 필요한 서비스에 Sticky를 적용(사실상 Stateful)

효과:
- 전역 트래픽 분산은 완전 Stateless, DNS 캐싱 활용  
- 로컬 서비스에서는 사용자 경험을 위해 세션 지속성 일부 보장

---

### 5) 세션은 외부 저장(완전 Stateless) + 보조적으로 IP Hash 사용

- 애플리케이션은 세션을 **항상 Redis/DB에 저장** → 서버는 완전 Stateless하게 설계
- LB는 원칙적으로 Stateless (Round Robin / Least Connections)
- 다만,
  - 특정 API는 IP Hash/URL Hash를 적용해 캐시 효율을 높이거나
  - 같은 유저 요청이 같은 서버로 가도록 “약한 Affinity”만 주는 패턴

세션은 이미 외부에 있으므로 State 문제는 없고,  
LB의 해시 기반은 캐시 히트율·CPU 로컬리티 정도만 챙기는 용도로 사용.
