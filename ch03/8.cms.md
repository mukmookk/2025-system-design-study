# 3.7 Count–Min Sketch

Count–Min Sketch(CMS)는  
대규모 스트림 데이터에서 특정 key의 “등장 횟수”를  
작은 메모리로 빠르게 **근사 추정**하기 위한 확률적 데이터 구조이다.

Bloom Filter가 “존재 여부”를 판단한다면,  
Count–Min Sketch는 “얼마나 자주 등장했는지”를 추정한다.

---

## 1. Count–Min Sketch를 왜 쓰는가?

일반적으로 Key → Count를 저장하면 HashMap이 필요하다:
```
“burger” -> 12
“tacos”  -> 2
“iphone” -> 99
```

문제:
- key 종류가 수백만/수천만 개면 메모리가 폭발한다  
- 문자열 key 저장 + Count 저장 → 수백 MB ~ 수 GB 필요

Count–Min Sketch는 이러한 문제를 해결하기 위해  
**고정 크기(d × w)의 2차원 배열만 사용**한다.

### 특징
- key 수와 상관없이 메모리 사용량이 일정하다
- key 자체를 저장하지 않는다
- 업데이트는 빠르고 O(1)에 가깝다

---

## 2. 내부 구조

Count–Min Sketch는 다음으로 구성된다.

- d개의 서로 다른 해시 함수  
- 각 해시 함수마다 길이 w의 카운터 배열(row)

총 테이블 크기 = **d × w**

예:
```
table[4][10000]
```

key가 1억 개든, 10개든  
→ **항상 동일한 크기만 사용한다.**

이 점이 CMS가 “메모리 효율적”인 핵심 이유이다.

---

## 3. Update(증가) 과정

key가 등장할 때마다:

```python
for each hash function hi:
    table[i][ hi(key) ] += 1
```

즉, 한 key가 들어오면 d개의 카운터가 증가한다.

---

## 4. Query(조회) — 등장 횟수 추정

조회 시:
```
estimate = min( table[i][hi(key)] for i in all rows )
```

여러 row 중 **최소값**을 취하는 이유는  
일부 hash row에서 “충돌”로 인해 카운터가 과도하게 증가할 수 있기 때문이다.

---

## 5. 왜 과대평가될 수밖에 없는가? (핵심)

### 1) 해시 충돌로 인해 서로 다른 key가 동일 index를 공유한다

예:
```
row1: h1(“iphone”) = 12
h1(“ipad”)   = 12   ← 충돌

row3: h3(“iphone”) = 53
h3(“ipad”)   = 53   ← 충돌
```

이렇게 되면:

- “iphone”의 Count 증가가 “ipad” 카운터에도 반영됨
- “ipad”의 Count 증가도 “iphone”에 반영됨

즉 **서로가 서로의 카운트를 더하는 형태**가 된다.

---

### 2) Count–Min Sketch는 감소(--)가 없다

CMS는 “증가 연산”만 존재한다.

> count += 1

해시 충돌 때문에 잘못 증가된 카운트를  
줄일 방법이 없다.

그래서:

- 절대 과소평가되지 않는다 (underestimate 불가)
- 오직 **과대평가(overestimate)** 가능

---

## 6. 장점과 단점

### 장점
- key 개수와 관계없이 메모리 사용량이 고정
- 매우 빠른 업데이트 / 조회
- 실시간 로그, 인기 키워드, 트래픽 분석에 적합

### 단점
- 정확한 count가 아니라 근사값
- 해시 충돌 때문에 항상 과대평가 가능
- delete / 감소 연산이 어렵다

----

## 7. Redis 예시

https://redis.io/docs/latest/develop/data-types/probabilistic/count-min-sketch/

-----

## 8. Bloom Filter와 비교

| 항목 | Bloom Filter | Count–Min Sketch |
|------|--------------|------------------|
| 목적 | 존재 여부 판단 | 등장 빈도 추정 |
| 오류 | False Positive | 과대평가(Overestimate) |
| 사용처 | 캐시 미스 방지 | 실시간 인기 추적 |

