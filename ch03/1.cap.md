# CAP 정리 (CAP Theorem)

CAP 정리는 분산 시스템에서 **Consistency(일관성), Availability(가용성), Partition Tolerance(파티션 허용성)**  
세 가지 속성을 동시에 완벽하게 만족할 수 없다는 이론이다.  
네트워크 파티션(P)이 발생할 경우 **일관성(C)** 또는 **가용성(A)** 중 하나를 반드시 포기해야 한다고 설명한다.

---

## 1. CAP 정리의 구성 요소

### 1) Consistency (일관성)
- 모든 노드가 **같은 시점에 동일한 값**을 반환해야 한다.
- “읽기 = 항상 최신 쓰기 결과”  
- 예: 강한 일관성 DB, 은행 잔고

### 2) Availability (가용성)
- 모든 요청에 대해 **항상 응답을 반환**한다.
- 일부 노드가 장애여도 서비스는 지속

### 3) Partition Tolerance (파티션 허용성)
- 네트워크 단절이 발생해도 시스템이 가능한 정상적으로 동작
- 분산 시스템에서는 “파티션은 반드시 발생한다”가 전제

---

## 2. CAP 정리 핵심 문장

> “네트워크 파티션이 발생하면, C(일관성)과 A(가용성) 중 **오직 하나만** 선택할 수 있다.”

왜냐하면:
- 파티션(P) 상황에서는 노드 간 통신이 불가하므로  
  **동시에 일관성 + 가용성**을 모두 보장하는 것은 물리적으로 불가능하기 때문

결과적으로,
- P는 분산 구조에서는 **항상 선택(필수)**  
- 결국 **C 또는 A 중 하나**만 선택 → CP 또는 AP 시스템

---

## 3. CP 시스템 (Consistency + Partition Tolerance)

### 특징
- 파티션 발생 시 **일관성을 우선**  
- 일관성을 지키기 위해 일부 요청을 차단하거나 에러 반환
- 가용성이 떨어질 수 있음

### 실무 예시
- ZooKeeper  
- Etcd  
- HBase  
- 대부분의 RDB 강한 일관성 모드

### 언제 선택하는가?
- 금융, 결제, 주문, 재고 같은 “틀려서는 안 되는 데이터”
- 데이터 무결성 > 서비스 연속성일 때

---

## 4. AP 시스템 (Availability + Partition Tolerance)

### 특징
- 파티션 상황에서도 서비스 지속  
- 데이터는 잠시 불일치할 수 있으나 시스템은 중단되지 않음  
- 나중에 동기화(eventual consistency)

### 실무 예시
- Cassandra  
- DynamoDB  
- Riak  
- Redis Cluster(일부 모드)  
- CDN, SNS 조회수, 로그 시스템

### 언제 선택하는가?
- 사용자 경험(UX) > 데이터 일치성  
- 글로벌 대규모 서비스  
- 불일치가 순간적으로 허용 가능한 경우  

---

## 5. 왜 P(파티션 허용성)는 반드시 선택해야 하는가?

분산 시스템은 본질적으로 네트워크 기반이다.  
클라우드, 리전·AZ 간 통신, 로드밸런서, 라우터 등 **네트워크 장애는 반드시 발생**한다.

따라서 “P를 포기하겠다”는 말은  
→ 분산 시스템을 사용하지 않겠다  
와 동일한 의미다.

---

## 6. CAP 정리를 실무에서 어떻게 사용해야 하는가?

### 1) 시스템이 어떤 유형인지 분류한다
- Cassandra → AP  
- Zookeeper → CP  
- MongoDB → 기본 AP, 설정에 따라 CP 가능  
- Kafka → 레플리카 정책에 따라 CP-like 또는 AP-like

### 2) 비즈니스 요구를 분석한다
- 불일치가 치명적이면 CP  
- 지연 시간/가용성이 중요한 서비스는 AP

### 3) C 또는 A 선택은 트레이드오프다
- 강한 일관성을 고르면 성능 저하 가능  
- 높은 가용성을 고르면 데이터 불일치가 발생 가능

### 4) 네트워크 파티션 상황을 반드시 고려해야 한다
- 장애 시 시스템이 어떻게 행동할지(에러 반환 or stale data 허용) 설계 필요

---

## 참고) Kafka 사례

| ACK 수준        | 설명                              | CAP 성향           |
|-----------------|-----------------------------------|---------------------|
| `acks=0`        | 메시지 받았는지 확인 안 함        | AP (가용성 우선)    |
| `acks=1`        | 리더만 쓰면 OK                    | AP에 가까움         |
| `acks=all`(-1)  | ISR 모두 쓰기 성공해야 OK         | CP 성향             |


그 외에도 `unclean.leader.election`, `min.insync.replicas` 설정 등을 통해 CP와 AP 간 조정이 가능함.

