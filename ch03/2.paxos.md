# **3.2.1 Paxos 알고리즘**

Paxos는 **분산 환경에서 여러 노드가 동일한 값에 합의(Consensus)하도록 보장하는 알고리즘**이다.  
네트워크 지연, 메시지 유실, 노드 장애가 존재하는 비동기 환경에서도 **일관성(Consistency)**을 반드시 유지하는 것이 목표다.

---

## **1. Paxos가 필요한 이유**

분산 시스템에서는 다음 문제가 항상 발생할 수 있다.

- 메시지 지연 또는 순서 뒤바뀜
- 메시지 유실
- 노드 장애 또는 정지
- 네트워크 파티션

이 상황에서도  
**“한 번 합의된 값은 어디에서도 동일하게 보존되어야 한다”**  
라는 요구를 만족하기 위해 Paxos가 등장했다.

---

## **2. Paxos의 핵심 역할**

| 역할 | 설명 |
|------|------|
| **Proposer** | 값을 제안하는 노드 |
| **Acceptor** | 제안 수락 여부를 결정하는 노드 |
| **Learner** | 최종 합의 결과를 학습하는 노드 |

합의는 **과반수(A majority quorum)** Acceptor가 승인해야 성립한다.

---

## **3. Paxos 알고리즘의 2단계(2-Phase)**

### **1단계: Prepare 단계**

- Proposer는 고유한 proposal number(n)를 선택해 모든 Acceptor에게 `Prepare(n)` 메시지를 보낸다.
- Acceptor는 조건을 만족하면 다음을 약속한다(Promise):
  - **n보다 작은 번호의 Proposal은 수락하지 않겠다.**
  - 자신이 이전에 수락한 Proposal 중 가장 번호가 큰 값을 Proposer에게 알려준다.

→ 목적: “낡은 Proposal”을 배제하고 충돌을 방지.

---

### **2단계: Accept 단계**

- Proposer는 Acceptor들로부터 받은 응답 중  
  **가장 번호가 큰 Proposal에 포함된 값이 있으면 그 값을 채택하여**  
  `Accept(n, value)` 메시지를 보낸다.
- Acceptor는 자신이 Promise한 번호보다 큰(n) 제안이면 Accept한다.
- 과반수의 Acceptor가 Accept하면 값이 최종 합의된다.

→ 목적: 하나의 값만 선택되도록 보장.

---

## **4. Paxos가 보장하는 특성**

### **1) Safety (안전성)**
- 두 개의 서로 다른 값이 동시에 선택될 수 없음
- 한 번 선택된 값은 절대 바뀌지 않음

### **2) Fault Tolerance (장애 허용)**
- Acceptor의 과반수만 살아 있으면 합의 가능

### **3) Consistency 우선 (CP 계열)**
- 네트워크 파티션 중에도 “잘못된 합의”는 절대 발생하지 않음
- 가용성은 상황에 따라 희생될 수 있음

---

## **5. Paxos가 실제로 사용된 기술**

### **(1) Google Chubby**
- Google 전체 서비스에서 사용되는 **분산 락 서비스**
- Paxos 기반으로 메타데이터 합의/리더 선출 수행

### **(2) Apache Zookeeper (초기 디자인 영향)**
- ZAB 프로토콜을 통해 Paxos 개념을 기반으로 발전
- Kafka, Hadoop, HBase의 메타데이터 관리에 사용

### **(3) Microsoft Azure Storage**
- Paxos 기반 log replication 구조 적용

### **(4) Spanner (초기 합의 구조에 Paxos 활용, 이후 Multi-Paxos + TrueTime 결합)**

실무에서 가장 널리 쓰이는 합의 알고리즘인 Raft도  
**Paxos의 복잡함을 대체하기 위해 고안된 Paxos 계열 알고리즘**이다.

---

## **6. Paxos 합의 과정 예시**

아래는 실제 합의가 어떻게 발생하는지 이해하기 위한 구체적 예시다.

### **환경**
- Acceptor A1, A2, A3 (3개 → 과반수는 2)
- Proposer P1, P2
- 두 Proposer가 서로 다른 값을 제안하려는 상황

---

### **1) P1이 값 “X”를 제안**
1. **Prepare(1)** → A1, A2, A3 전송  
2. 모든 Acceptor는 기존 Proposal 없음 → Promise  
3. P1은 **Accept(1, X)** 전송  
4. A1, A2가 Accept → 과반수 달성 → **값 X가 합의됨**

---

### **2) P2가 동시에 값 “Y”를 제안하려 함**
1. P2는 더 큰 번호로 **Prepare(2)** 전송  
2. Acceptor들은 다음을 응답:
   - “나는 (1, X)를 전에 Accept 했음”  
3. Proposer P2는 규칙에 따라  
   **가장 최신의 값 X를 다시 제안해야 함**
4. Accept(2, X) 전송  
5. 과반수 Accept → 최종 값은 **X로 유지**

---

### 결과  
- 두 Proposer가 서로 다른 값을 제안해도  
  **선택된 값은 오직 하나(X)**  
- 즉, Paxos는 **일관성(Consistency)**를 100% 보장한다.

---

## **Paxos의 Slot 개념**

Paxos는 기본적으로 **한 번의 합의(Instance)에 하나의 값만 확정**할 수 있다.  
그러나 실제 시스템에서는 로그처럼 여러 값을 **순서대로** 합의해야 한다.

이를 해결하기 위해 Paxos는 **Slot(슬롯)**이라는 개념을 사용한다.

---

### **1) Slot은 “값이 기록될 위치”**
- Slot 1, Slot 2, Slot 3 … 과 같이 번호가 붙는다.
- 각 Slot은 독립적인 Paxos 합의 과정을 가진다.
- 즉, Slot = ‘이 값을 어디에 적을 것인가’를 나타내는 인덱스.

---

### **2) Slot은 독립적인 합의 인스턴스**
- Slot 1에서 합의된 값은 Slot 1에만 영향을 준다.
- Slot 2는 Slot 2만의 Prepare/Accept 라운드를 가진다.  
→ 슬롯별로 Paxos가 따로 동작한다고 보면 된다.

---

### **3) Slot은 Commit되면 불변(Immutable)**
- 한 Slot에서 값이 Accept → Commit되면 다시 변경할 수 없다.
- 새로운 값을 합의하려면 **새로운 Slot 번호**로 새 Paxos 라운드를 시작해야 한다.  
→ Slot 1이 Commit되면 Slot 1에 다시 값을 넣는 것은 불가능.

---

# **Apache Zookeeper 사례 **

Apache Zookeeper는 분산 시스템에서 널리 사용되는 **메타데이터 관리·분산 코디네이션 서비스**이며,  
초기 설계는 Paxos 아이디어를 기반으로 했지만, 실제 구현은 **ZAB(Zookeeper Atomic Broadcast)**라는 프로토콜을 사용한다.

ZAB은 Paxos의 원리를 단순화하여 다음 기능을 제공한다.

---

## **1. Zookeeper는 Paxos처럼 “Slot 기반 Log Replication” 구조를 사용한다**

Zookeeper의 모든 상태 변경은 다음과 같은 구조로 기록된다.

- 변경 명령은 **트랜잭션 ID(ZXID)** 라는 단조 증가 번호를 가진다  
  → Paxos의 **Slot 번호**와 동일한 역할
- 모든 서버(노드)는 **동일한 순서로 커밋된 로그**를 가지고 있어야 한다
- ZXID 순서에 따라 로그를 append-only 방식으로 쌓는다

이 방식 덕분에 모든 서버는 항상 동일한 순서를 공유하며  
일관성을 유지할 수 있다.

---

## **2. Zookeeper의 리더 선출도 Paxos 개념을 따른다**

Paxos와 마찬가지로:

- 다수의 서버 중 한 노드를 **Leader**로 선출
- Leader가 로그를 순서대로 브로드캐스트
- Follower들은 이를 받아 커밋

리더 선출 알고리즘(Election)은 Paxos의 구조와 거의 동일하며  
Quorum을 기반으로 한다.

---

## **3. ZAB와 Paxos의 차이**

| 구분 | Paxos | ZAB(Zookeeper Atomic Broadcast) |
|------|--------|-----------------------------------|
| 목적 | 하나의 값 합의 | **순서 있는 로그 복제** |
| 모델 | 값 단위 합의 | **Broadcast + Commit** |
| Slot | 각각의 Paxos 인스턴스 | ZXID(Log Index) |
| Leader | 없어도 동작 가능 | **Leader 필수** |
| 사용처 | 이론적 합의 알고리즘 | **Zookeeper 실제 구현** |

즉, ZAB은 “Paxos를 실제 서비스에서 쓰기 쉽게 단순화한 합의·복제 프로토콜”이다.

---

## **4. Zookeeper에서 Paxos 개념이 사용되는 부분 요약**

- **Quorum 기반 합의**  
  → 과반수 서버가 응답해야 Commit 가능

- **Slot(=ZXID) 기반 로그 구조**  
  → Paxos의 Slot과 동일한 개념

- **Leader-Follower 복제 모델**  
  → Multi-Paxos 구조와 동일

- **Append-only Log Commit**  
  → 합의된 값은 immutable하며, 새로운 값은 새로운 Slot에 기록
